# Ozza Application - Authentication & User Management

## Overview
Ozza is a multi-tenant coaching platform with a hierarchical role system (Coach → Agency → Client). The application uses Better Auth for authentication with PostgreSQL and Drizzle ORM.

## Authentication System

### Core Configuration
- **Framework**: Better Auth with Next.js integration
- **Database**: PostgreSQL with Drizzle adapter
- **Providers**: Email/password + Google OAuth
- **Session**: Cookie-based, no email verification required
- **Base Config**: `lib/auth.ts:27-101`

### User Schema
```typescript
// Core user table (db/schema.ts:5-14)
user: {
  id: text (primary)
  name: text
  email: text (unique)
  emailVerified: boolean (default: false)
  image: text
  role: text (default: 'client') // client|coach|agency|admin
  timestamps: createdAt, updatedAt
}
```

## User Creation Flows

### 1. Standard Registration
- Users register via Better Auth (email/password or Google)
- Default role: 'client'
- Optional profile creation via `app/api/create-user-profile/route.ts`

### 2. Invite-Based Registration
- **Client Invites**: Generated by agencies, links clients to agency accounts
- **Agency Invites**: Generated by coaches, links agencies to coach accounts
- Uses secure tokens with expiration dates

### 3. Role Assignment
- Post-registration role updates via `app/api/signup-with-role/route.ts`
- Associates users with accounts based on invite type

## Invite Link System

### Client Invitations
```typescript
// Table: client_invitations (db/schema.ts:108-118)
{
  token: unique invite token
  client_name: invitee name
  client_email: invitee email
  account_id: agency account reference
  expires_at: expiration timestamp
  status: pending|used
}
```

**Flow**:
1. Agency generates invite via `ClientInvitationGenerator.tsx`
2. Client clicks invite link with token
3. Verification via `app/api/verify-client-invite/route.ts`
4. User signup associates client with agency account

### Agency Invitations
```typescript
// Table: agency_invitations (db/schema.ts:174-184)
{
  token: unique invite token
  agency_name: invitee name
  agency_email: invitee email
  coach_account_id: coach account reference
  expires_at: expiration timestamp
  status: pending|used
}
```

**Flow**: Similar to client invites but links agencies to coach accounts

## Multi-Tenant Architecture

### Account System
```typescript
// Primary accounts table (db/schema.ts:79-88)
ozza_accounts: {
  id: primary key
  name: account name
  owner_id: user reference
  branding: logo_url, colors
}

// Membership linking (db/schema.ts:90-96)
ozza_account_members: {
  user_id: user reference
  account_id: account reference
  role: member role within account
}
```

### Role Hierarchy
1. **Coach**: Top-level, owns coach accounts, manages agencies
2. **Agency**: Mid-level, belongs to coach accounts, manages clients
3. **Client**: End users, belongs to agency accounts
4. **Admin**: System administrators

## Dashboard Routing

### Role-Based Redirects (`app/dashboard/page.tsx:28-42`)
- **Authentication Check**: Verifies session via Better Auth
- **Role Detection**: Queries user table for role
- **Route Mapping**:
  - `coach` → `/dashboard/coach`
  - `agency`/`admin` → `/dashboard/agency` 
  - `client` → `/dashboard/client`
  - Default fallback → `/dashboard/coach`

### Portal Structure
- Dynamic routing: `/dashboard/[portalType]`
- Portal-specific components and layouts
- Shared sidebar/navbar with role-based navigation

## Key API Endpoints

### Authentication
- `app/api/auth/[...all]/route.ts` - Better Auth handlers
- `app/api/signup-with-role/route.ts` - Post-signup role assignment
- `app/api/user-roles/route.ts` - User account memberships

### Invitations
- `app/api/verify-client-invite/route.ts` - Client invite validation
- `app/api/verify-agency-invite/route.ts` - Agency invite validation
- `app/api/mark-*-invite-used/route.ts` - Mark invites as consumed

### User Management
- `app/api/create-user-profile/route.ts` - Extended profile creation
- `app/api/client-invitations/route.ts` - Client invitation management

## Database Schema Highlights

### Better Auth Tables
- `user`, `session`, `account`, `verification` - Standard Better Auth schema

### Custom Ozza Tables
- `ozza_accounts` - Multi-tenant accounts
- `ozza_account_members` - User-account relationships
- `user_profiles` - Extended user data
- `client_invitations` / `agency_invitations` - Invite systems
- `community_links` - Community-based signups

### Supporting Tables
- `plans`, `features`, `account_features` - Subscription management
- `domains` - Custom domain mapping
- `billing_events` - Payment processing events

## Important Files

### Core Authentication
- `lib/auth.ts` - Better Auth configuration
- `lib/auth-client.ts` - Client-side auth utilities
- `auth-schema.ts` - Legacy auth schema
- `db/schema.ts` - Complete database schema

### User Interface
- `components/ClientInvitationGenerator.tsx` - Invite generation UI
- `app/dashboard/layout.tsx` - Dashboard layout with role detection
- `app/dashboard/page.tsx` - Role-based routing logic

### API Routes
- `app/api/signup-with-role/` - Role assignment
- `app/api/verify-*-invite/` - Invite validation
- `app/api/user-roles/` - User membership queries

## Development Notes

### Testing Authentication
- Use `/sign-in` and `/sign-up` routes
- Test invite flows with generated tokens
- Verify role-based dashboard access

### Database Migrations
- Drizzle migrations in `db/migrations/`
- Schema changes require migration generation
- Role field added via migration: `0002_add_role_to_user.sql`

### Environment Variables
- `BETTER_AUTH_SECRET` - Auth encryption key
- `GOOGLE_CLIENT_ID/SECRET` - OAuth credentials
- `NEXT_PUBLIC_APP_URL` - Base application URL
- Database connection strings for PostgreSQL